window.onload = function() {
  $('#overdue_report').addClass('active');
//  get_maintenance_reports();
$('#overdue_table').hide();
$('#history_table').hide();
  get_all_stations();
//  get_maintenance_reports();
};

var token =  $("input[name=_token]").val();
function get_all_stations(){
	$.ajax({
		url: '/common/allstations',
		type: 'GET',
		dataType: 'JSON',
		success: function(data){
			$('#station_id').empty();
			for(var i in data){
			  $('#station_id').append('<option value="'+data[i].id+'">'+data[i].code+'</option>');
			}
		}
	}).promise().done(function(data) {
        $select_station_id = $('#select_station_id').selectize({
        	maxItems: null,valueField: 'id',labelField: 'code',searchField: 'code',options: data,create: false
        });
    });
}
function get_maintenance_reports(){
  $('#overdue_table').show();
  $('#history_table').hide();
  var formData = $('form#overdue-form').serializeArray();
  var stations=$('#select_station_id').val();
  if(stations!=null){


  	$('#saveBtn').attr('disabled', true).html('PLEASE WAIT..');
    $('#data-list').html('<tr><td colspan="9"><center><i class="fa fa-spinner fa-spin fa-3x"></i></center></td></tr>');


  $.ajax({
    url: '/report/overduegearbystation',
    type: 'POST',
    datatype: 'JSON',
    data: formData,
    success: function(data){
      $('#data-list').empty();
      if(data.length==0){
        $('#data-list').append('<tr><td colspan="9"><center><h4 class="label label-danger text-center">No data found</h4></center></td></tr>');

      }
      var count=0;
        for(var i in data){

          count = count+1;
      var row = '<tr>'
    					+'<td>'+data[i].station+'</td>'
    					+'<td>'+data[i].type+'</td>'
    					+'<td>'+data[i].gear_no+'</td>'
    					+'<td>'+data[i].schedule_code+'/'+data[i].role+'</td>'
              +'<td class="text text-danger">'+moment(data[i].due_date).format('DD/MM/YY')+'</td>'
              +'<td><button class="btn btn-info btn-sm" onClick="getGearHistory('+data[i].station_gear_id+')">View history</button></td>'
    					+'</tr>';
    			$('#data-list').append(row);


        }
        $('#overdue_gears_count').empty().append(count);

      }

  });
}else{

  alertify.error('Please select Station(s)');
}
}
var token =  $("input[name=_token]").val();
$("#back_btn").on("click", function () {
  $('#overdue_table').show();
  $('#history_table').hide();


});
function getGearHistory(station_gear_id){
  $('#overdue_table').hide();
  $('#history_table').show();

  $.ajax({
    url: '/report/gearhistory',
    type: 'POST',
    data:{'station_gear_id':station_gear_id,'_token':token},
    dataType: 'JSON',
    success: function(data){
      $('#history_list').empty();
      for(var i in data){
        var periodicity_level;
        if(data[i].role_id==1){
          periodicity_level=data[i].periodicity_level_1;
        }else{
          periodicity_level=data[i].periodicity_level_2;
        }
        var row ="<tr>"
                  +"<td>"+data[i].code+"</td>"
                  +"<td>"+data[i].role+"</td>"
                  +"<td>"+periodicity_level+" days</td>"
                  +"<td>"+moment(data[i].maintenance_date).format('DD/MM/YY')+"</td>"
                  +"<td>"+moment(data[i].next_maintenance_date).format('DD/MM/YY')+"</td>"
                  +"<td>"+data[i].maintenance_by+"//"+data[i].designation+"</td>"
                  +"<td>"+data[i].discontinuation_status+"</td>"
                  +"<td>"+data[i].remarks+"</td>"
                  +"</tr>";
        $('#history_list').append(row);
      }
      $("#model_title").empty().append("Maintenance history ");
      $('#history_model').modal('show')
    }
  });

}
$("#print_report").on("click", function () {
 printDiv();

});
function printDiv()
{
  var divToPrint=document.getElementById('maintenance_reports');
  newWin= window.open("");
  //console.log(divToPrint.outerHTML);
  newWin.document.write('<h3>Overdue Gear Maintenance Report on <small>'+moment(new Date()).format('DD/MM/YY')+'</small></h3>');
  newWin.document.write(divToPrint.outerHTML);
  newWin.document.write('<small>Report generated by DSMG monitoring software (Tinsukia Division): all date format are in <b>dd/mm/yy</b></small>');
  newWin.print();
  //newWin.close();
}
$("#excel_report").click(function() {
	$("#maintenance_reports").table2excel({
		exclude : ".noExl",
    name : "maintainance_report",
    filename: "maintainance_report"
	});
});
